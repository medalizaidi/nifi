version: 2.1

jobs:
  runner-test:
    machine: true
    resource_class: avaxia-test/ci
    steps:
      - run: 
          name: Test runner and environment
          command: |
            echo "‚úÖ Runner is working!"
            echo "User: $(whoami)"
            echo "Home: $HOME"
            echo "Working dir: $(pwd)"
            echo ""
            echo "Environment variables:"
            echo "CIRCLE_REPOSITORY_URL: ${CIRCLE_REPOSITORY_URL}"
            echo "CIRCLE_BRANCH: ${CIRCLE_BRANCH}"
            echo "CIRCLE_SHA1: ${CIRCLE_SHA1}"
            echo ""
            echo "Git version: $(git --version)"
            echo "Python version: $(python3 --version)"

  test-connection:
    machine: true
    resource_class: avaxia-test/ci
    steps:
      - run:
          name: Test NiFi connectivity
          command: |
            echo "=========================================="
            echo "Testing NiFi instances..."
            echo "=========================================="
            
            echo "Registry (18080):"
            if curl -s -o /dev/null -w "%{http_code}" http://localhost:18080/nifi-registry 2>/dev/null | grep -q "200\|302"; then
              echo "‚úÖ Accessible"
            else
              echo "‚ùå Not accessible"
            fi
            
            echo ""
            echo "Staging (8082):"
            if curl -s http://localhost:8082/nifi-api/flow/about 2>/dev/null | grep -q version; then
              echo "‚úÖ Accessible"
              curl -s http://localhost:8082/nifi-api/flow/about | grep -o '"version":"[^"]*"'
            else
              echo "‚ùå Not accessible"
            fi
            
            echo ""
            echo "Production (8083):"
            if curl -s http://localhost:8083/nifi-api/flow/about 2>/dev/null | grep -q version; then
              echo "‚úÖ Accessible"
              curl -s http://localhost:8083/nifi-api/flow/about | grep -o '"version":"[^"]*"'
            else
              echo "‚ùå Not accessible"
            fi

  deploy-staging:
    machine: true
    resource_class: avaxia-test/ci
    steps:
      - run:
          name: Clone repository
          command: |
            echo "Setting up workspace..."
            
            REPO_URL="${CIRCLE_REPOSITORY_URL:-https://github.com/medalizaidi/nifi.git}"
            BRANCH="${CIRCLE_BRANCH:-main}"
            WORKSPACE="/tmp/nifi-deploy"
            
            echo "Repository: $REPO_URL"
            echo "Branch: $BRANCH"
            echo "Workspace: $WORKSPACE"
            
            # Clean workspace if it exists
            rm -rf $WORKSPACE
            mkdir -p $WORKSPACE
            
            # Clone repository
            echo "Cloning repository..."
            git clone $REPO_URL $WORKSPACE
            
            cd $WORKSPACE
            git checkout $BRANCH
            
            echo "‚úÖ Repository cloned"
            echo "Files:"
            ls -la
      
      - run:
          name: Install Python dependencies
          command: |
            echo "Installing Python dependencies..."
            pip3 install nipyapi requests urllib3 --break-system-packages 2>/dev/null || \
            pip3 install nipyapi requests urllib3 || \
            pip install nipyapi requests urllib3
            
            echo "‚úÖ Dependencies installed"
      
      - run:
          name: Deploy to staging
          command: |
            cd /tmp/nifi-deploy
            
            export NIFI_API="http://localhost:8082/nifi-api"
            export REGISTRY_API="http://localhost:18080/nifi-registry-api"
            export BUCKET_NAME="${BUCKET_NAME:-test}"
            export FLOW_NAME="${FLOW_NAME:-demo}"
            
            echo "=========================================="
            echo "üöÄ Deploying to Staging"
            echo "=========================================="
            echo "NIFI_API: $NIFI_API"
            echo "REGISTRY_API: $REGISTRY_API"
            echo "BUCKET_NAME: $BUCKET_NAME"
            echo "FLOW_NAME: $FLOW_NAME"
            echo ""
            
            if [ -f "deploy_flow.py" ]; then
              echo "Running deployment script..."
              python3 deploy_flow.py staging || python deploy_flow.py staging
              echo ""
              echo "‚úÖ Deployment completed successfully"
            else
              echo "‚ùå deploy_flow.py not found!"
              echo "Available files:"
              ls -la
              exit 1
            fi

  deploy-production:
    machine: true
    resource_class: avaxia-test/ci
    steps:
      - run:
          name: Clone repository
          command: |
            REPO_URL="${CIRCLE_REPOSITORY_URL:-https://github.com/medalizaidi/nifi.git}"
            BRANCH="${CIRCLE_BRANCH:-main}"
            WORKSPACE="/tmp/nifi-deploy"
            
            rm -rf $WORKSPACE
            mkdir -p $WORKSPACE
            
            git clone $REPO_URL $WORKSPACE
            cd $WORKSPACE
            git checkout $BRANCH
            
            echo "‚úÖ Repository ready"
      
      - run:
          name: Install Python dependencies
          command: |
            pip3 install nipyapi requests urllib3 --break-system-packages 2>/dev/null || \
            pip3 install nipyapi requests urllib3 || \
            pip install nipyapi requests urllib3
      
      - run:
          name: Deploy to production
          command: |
            cd /tmp/nifi-deploy
            
            export NIFI_API="http://localhost:8083/nifi-api"
            export REGISTRY_API="http://localhost:18080/nifi-registry-api"
            export BUCKET_NAME="${BUCKET_NAME:-test}"
            export FLOW_NAME="${FLOW_NAME:-test}"
            
            echo "=========================================="
            echo "üî• Deploying to PRODUCTION"
            echo "=========================================="
            echo "NIFI_API: $NIFI_API"
            echo "REGISTRY_API: $REGISTRY_API"
            echo "BUCKET_NAME: $BUCKET_NAME"
            echo "FLOW_NAME: $FLOW_NAME"
            echo ""
            
            if [ -f "deploy_flow.py" ]; then
              echo "Running deployment script..."
              python3 deploy_flow.py prod || python deploy_flow.py prod
              echo ""
              echo "‚úÖ Production deployment completed successfully"
            else
              echo "‚ùå deploy_flow.py not found!"
              exit 1
            fi

workflows:
  version: 2
  
  # Simple test
  testing:
    jobs:
      - runner-test
  
  # Main deployment workflow
  deploy-flows:
    jobs:
      - test-connection:
          filters:
            branches:
              only: main
      
      - deploy-staging:
          requires:
            - test-connection
          filters:
            branches:
              only: main
      
      - hold-production:
          type: approval
          requires:
            - deploy-staging
          filters:
            branches:
              only: 
                - main
                - /release\/.*/
      
      - deploy-production:
          requires:
            - hold-production
          filters:
            branches:
              only:
                - main
                - /release\/.*/