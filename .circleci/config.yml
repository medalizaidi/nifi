version: 2.1

jobs:
  deploy-staging:
    machine: true
    resource_class: avaxia-test/ci
    steps:
      - run:
          name: Clone repository
          command: |
            echo "Setting up workspace..."
            
            REPO_URL="${CIRCLE_REPOSITORY_URL:-https://github.com/medalizaidi/nifi.git}"
            BRANCH="${CIRCLE_BRANCH:-main}"
            WORKSPACE="/tmp/nifi-deploy"
            
            echo "Repository: $REPO_URL"
            echo "Branch: $BRANCH"
            echo "Workspace: $WORKSPACE"
            
            # Clean workspace if it exists
            rm -rf $WORKSPACE
            mkdir -p $WORKSPACE
            
            # Clone repository
            echo "Cloning repository..."
            git clone $REPO_URL $WORKSPACE
            
            cd $WORKSPACE
            git checkout $BRANCH
            
            echo "‚úÖ Repository cloned"
            echo "Files:"
            ls -la
      
      - run:
          name: Install Python dependencies
          command: |
            echo "Installing Python dependencies..."
            pip3 install nipyapi requests urllib3 --break-system-packages 2>/dev/null || \
            pip3 install nipyapi requests urllib3 || \
            pip install nipyapi requests urllib3
            
            echo "‚úÖ Dependencies installed"
      
      - run:
          name: Deploy to staging
          command: |
            cd /tmp/nifi-deploy
            
            # Use environment variables from CircleCI project settings
            export NIFI_API="${NIFI_STG_URL:-http://localhost:8082/nifi-api}"
            export REGISTRY_API="${NIFI_REGISTRY_URL:-http://localhost:18080/nifi-registry-api}"
            export BUCKET_NAME="${BUCKET_NAME:-test}"
            export FLOW_NAME="${FLOW_NAME:-demo}"
            export NIFI_USERNAME="${NIFI_USERNAME}"
            export NIFI_PASSWORD="${NIFI_PASSWORD}"
            
            echo "=========================================="
            echo "üöÄ Deploying to Staging"
            echo "=========================================="
            echo "NIFI_API: $NIFI_API"
            echo "REGISTRY_API: $REGISTRY_API"
            echo "BUCKET_NAME: $BUCKET_NAME"
            echo "FLOW_NAME: $FLOW_NAME"
            echo "NIFI_USERNAME: ${NIFI_USERNAME:+***set***}"
            echo ""
            
            if [ -f "deploy_flow.py" ]; then
              echo "Running deployment script..."
              python3 deploy_flow.py staging || python deploy_flow.py staging
              echo ""
              echo "‚úÖ Deployment completed successfully"
            else
              echo "‚ùå deploy_flow.py not found!"
              echo "Available files:"
              ls -la
              exit 1
            fi

  deploy-production:
    machine: true
    resource_class: avaxia-test/ci
    steps:
      - run:
          name: Clone repository
          command: |
            REPO_URL="${CIRCLE_REPOSITORY_URL:-https://github.com/medalizaidi/nifi.git}"
            BRANCH="${CIRCLE_BRANCH:-main}"
            WORKSPACE="/tmp/nifi-deploy"
            
            rm -rf $WORKSPACE
            mkdir -p $WORKSPACE
            
            git clone $REPO_URL $WORKSPACE
            cd $WORKSPACE
            git checkout $BRANCH
            
            echo "‚úÖ Repository ready"
      
      - run:
          name: Install Python dependencies
          command: |
            pip3 install nipyapi requests urllib3 --break-system-packages 2>/dev/null || \
            pip3 install nipyapi requests urllib3 || \
            pip install nipyapi requests urllib3
      
      - run:
          name: Deploy to production
          command: |
            cd /tmp/nifi-deploy
            
            # Use environment variables from CircleCI project settings
            export NIFI_API="${NIFI_PROD_URL:-http://localhost:8083/nifi-api}"
            export REGISTRY_API="${NIFI_REGISTRY_URL:-http://localhost:18080/nifi-registry-api}"
            export BUCKET_NAME="${BUCKET_NAME:-test}"
            export FLOW_NAME="${FLOW_NAME:-test}"
            export NIFI_USERNAME="${NIFI_USERNAME}"
            export NIFI_PASSWORD="${NIFI_PASSWORD}"
            
            echo "=========================================="
            echo "üî• Deploying to PRODUCTION"
            echo "=========================================="
            echo "NIFI_API: $NIFI_API"
            echo "REGISTRY_API: $REGISTRY_API"
            echo "BUCKET_NAME: $BUCKET_NAME"
            echo "FLOW_NAME: $FLOW_NAME"
            echo "NIFI_USERNAME: ${NIFI_USERNAME:+***set***}"
            echo ""
            
            if [ -f "deploy_flow.py" ]; then
              echo "Running deployment script..."
              python3 deploy_flow.py prod || python deploy_flow.py prod
              echo ""
              echo "‚úÖ Production deployment completed successfully"
            else
              echo "‚ùå deploy_flow.py not found!"
              exit 1
            fi

workflows:
  version: 2
  
  # Main deployment workflow
  deploy-flows:
    jobs:
      - deploy-staging:
          filters:
            branches:
              only: main
      
      - hold-production:
          type: approval
          requires:
            - deploy-staging
          filters:
            branches:
              only: 
                - main
                - /release\/.*/
      
      - deploy-production:
          requires:
            - hold-production
          filters:
            branches:
              only:
                - main
                - /release\/.*/
