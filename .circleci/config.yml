version: 2.1

parameters:
  triggered_by:
    type: string
    default: "manual"
  flow_commit:
    type: string
    default: ""
  flow_message:
    type: string
    default: ""
  flow_author:
    type: string
    default: ""

jobs:
  deploy-staging:
    machine: true
    resource_class: avaxia-test/ci
    steps:
      - run:
          name: Display trigger information
          command: |
            echo "=========================================="
            echo "ðŸš€ Deploying to STAGING"
            echo "Branch: ${CIRCLE_BRANCH}"
            echo "Triggered by: << pipeline.parameters.triggered_by >>"
            if [ "<< pipeline.parameters.triggered_by >>" = "flow_update" ]; then
              echo "Flow: << pipeline.parameters.flow_message >>"
              echo "Author: << pipeline.parameters.flow_author >>"
            fi
            echo "=========================================="
      
      - run:
          name: Clone repositories
          command: |
            WORKSPACE="/tmp/nifi-deploy"
            rm -rf $WORKSPACE
            mkdir -p $WORKSPACE
            
            git clone https://github.com/medalizaidi/nifi.git $WORKSPACE
            cd $WORKSPACE
            git checkout ${CIRCLE_BRANCH}
            
            echo "âœ… Repository cloned"
      
      - run:
          name: Install Python dependencies
          command: |
            pip3 install nipyapi requests urllib3 --break-system-packages 2>/dev/null || \
            pip3 install nipyapi requests urllib3
      
      - run:
          name: Deploy to staging
          command: |
            cd /tmp/nifi-deploy
            
            export NIFI_API="${NIFI_STG_URL}"
            export REGISTRY_API="${NIFI_REGISTRY_URL}"
            export BUCKET_NAME="${BUCKET_NAME:-test}"
            export FLOW_NAME="${FLOW_NAME:-demo}"
            
            python3 deploy_flow.py staging || python deploy_flow.py staging
            echo "âœ… Staging deployment completed"

  deploy-production:
    machine: true
    resource_class: avaxia-test/ci
    steps:
      - run:
          name: Production deployment info
          command: |
            echo "=========================================="
            echo "ðŸ”¥ Deploying to PRODUCTION"
            echo "Branch: ${CIRCLE_BRANCH}"
            echo "Commit: ${CIRCLE_SHA1:0:7}"
            echo "=========================================="
      
      - run:
          name: Clone repositories
          command: |
            WORKSPACE="/tmp/nifi-deploy"
            rm -rf $WORKSPACE
            mkdir -p $WORKSPACE
            
            git clone https://github.com/medalizaidi/nifi.git $WORKSPACE
            cd $WORKSPACE
            git checkout production
      
      - run:
          name: Install Python dependencies
          command: |
            pip3 install nipyapi requests urllib3 --break-system-packages 2>/dev/null || \
            pip3 install nipyapi requests urllib3
      
      - run:
          name: Deploy to production
          command: |
            cd /tmp/nifi-deploy
            
            export NIFI_API="${NIFI_PROD_URL}"
            export REGISTRY_API="${NIFI_REGISTRY_URL}"
            export BUCKET_NAME="${BUCKET_NAME:-test}"
            export FLOW_NAME="${FLOW_NAME:-test}"
            
            python3 deploy_flow.py prod || python deploy_flow.py prod
            echo "âœ… Production deployment completed"

workflows:
  version: 2
  
  # Deploy to staging on main branch
  deploy-staging:
    jobs:
      - deploy-staging:
          filters:
            branches:
              only: main
  
  # Deploy to production on production branch
  deploy-production:
    jobs:
      - deploy-production:
          filters:
            branches:
              only: production