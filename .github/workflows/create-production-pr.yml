name: Create Production PR

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  create-pr:
    name: Create PR to Production
    runs-on: self-hosted
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Check if PR already exists
        id: check_pr
        run: |
          echo "Checking for existing PRs..."
          RESPONSE=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${{ github.repository }}/pulls?state=open&base=production&head=${{ github.repository_owner }}:main")
          
          echo "API Response: $RESPONSE"
          
          PR_COUNT=$(echo "$RESPONSE" | grep -o '"number":' | wc -l)
          echo "pr_exists=$PR_COUNT" >> $GITHUB_OUTPUT
          
          if [ "$PR_COUNT" -gt 0 ]; then
            echo "âœ… PR already exists"
            PR_NUMBER=$(echo "$RESPONSE" | grep -o '"number":[0-9]*' | head -1 | cut -d: -f2)
            echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT
            echo "Existing PR: #$PR_NUMBER"
          else
            echo "ðŸ“ No PR exists, will create one"
          fi
      
      - name: Get latest commit info
        id: commit_info
        run: |
          COMMIT_MSG=$(git log -1 --pretty=%B | head -1)
          COMMIT_AUTHOR=$(git log -1 --pretty=%an)
          COMMIT_SHA=$(git rev-parse --short HEAD)
          
          echo "Commit: $COMMIT_SHA"
          echo "Message: $COMMIT_MSG"
          echo "Author: $COMMIT_AUTHOR"
          
          echo "message=$COMMIT_MSG" >> $GITHUB_OUTPUT
          echo "author=$COMMIT_AUTHOR" >> $GITHUB_OUTPUT
          echo "sha=$COMMIT_SHA" >> $GITHUB_OUTPUT
      
      - name: Create Pull Request
        if: steps.check_pr.outputs.pr_exists == '0'
        run: |
          echo "Creating PR..."
          
          PR_BODY="## ðŸš€ Deploy to Production

          **Latest Changes:** ${{ steps.commit_info.outputs.message }}

          **Author:** ${{ steps.commit_info.outputs.author }}  
          **Commit:** \`${{ steps.commit_info.outputs.sha }}\`

          ---

          ### Deployment Plan
          - âœ… Deployed to **Staging** successfully
          - â³ Waiting for approval to deploy to **Production**

          ### Review Checklist
          - [ ] Changes verified in staging environment
          - [ ] Tests passing
          - [ ] Ready for production deployment

          ---

          **After merging:** CircleCI will automatically deploy to production."
          
          # Create JSON payload
          cat > /tmp/pr_payload.json << JSONEOF
          {
            "title": "ðŸš€ Deploy to Production: ${{ steps.commit_info.outputs.message }}",
            "body": $(echo "$PR_BODY" | jq -Rs .),
            "head": "main",
            "base": "production"
          }
          JSONEOF
          
          echo "Payload:"
          cat /tmp/pr_payload.json
          
          # Create PR
          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            https://api.github.com/repos/${{ github.repository }}/pulls \
            -d @/tmp/pr_payload.json)
          
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')
          
          echo "HTTP Status: $HTTP_CODE"
          echo "Response Body:"
          echo "$BODY"
          
          if [ "$HTTP_CODE" -eq 201 ]; then
            PR_NUMBER=$(echo "$BODY" | jq -r '.number')
            PR_URL=$(echo "$BODY" | jq -r '.html_url')
            
            echo "âœ… Pull Request created successfully!"
            echo "PR Number: #$PR_NUMBER"
            echo "URL: $PR_URL"
          else
            echo "âŒ Failed to create PR"
            echo "Error: $(echo "$BODY" | jq -r '.message // "Unknown error"')"
            exit 1
          fi
          
          rm /tmp/pr_payload.json
      
      - name: Update existing PR
        if: steps.check_pr.outputs.pr_exists != '0'
        run: |
          PR_NUMBER=${{ steps.check_pr.outputs.pr_number }}
          
          echo "Updating PR #$PR_NUMBER..."
          
          COMMENT="ðŸ”„ **New changes pushed to staging**

          Latest commit: \`${{ steps.commit_info.outputs.sha }}\`  
          Message: ${{ steps.commit_info.outputs.message }}  
          Author: ${{ steps.commit_info.outputs.author }}
          
          Staging deployment completed. Ready for production review."
          
          curl -s -X POST \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            https://api.github.com/repos/${{ github.repository }}/issues/$PR_NUMBER/comments \
            -d "$(echo "{\"body\": $(echo "$COMMENT" | jq -Rs .)}")"
          
          echo "âœ… PR #$PR_NUMBER updated"