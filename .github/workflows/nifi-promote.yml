name: NiFi Flow CI/CD

on:
  push:
    branches: [ main ]
    paths:
      - "flows/**"

jobs:

  deploy-stg:
    name: Deploy to STG
    runs-on: ubuntu-latest
    environment: staging

    steps:
      - uses: actions/checkout@v4

      - name: Start NiFi STG
        run: docker-compose up -d nifi-stg

      - name: Wait for NiFi STG
        run: |
          until curl -s http://localhost:8082/nifi-api/system-diagnostics; do
            sleep 5
          done

      - name: Deploy Flow to STG
        run: |
          curl -X POST \
            http://localhost:8082/nifi-api/process-groups/root/process-groups/import \
            -F "file=@flows/order-ingestion-test.xml"

  deploy-prod:
    name: Deploy to PROD
    runs-on: ubuntu-latest
    needs: deploy-stg
    environment: production

    steps:
      - uses: actions/checkout@v4

      - name: Start NiFi PROD
        run: docker-compose up -d nifi-prod

      - name: Wait for NiFi PROD
        run: |
          until curl -s http://localhost:8083/nifi-api/system-diagnostics; do
            sleep 5
          done

      - name: Deploy Flow to PROD
        run: |
          curl -X POST \
            http://localhost:8083/nifi-api/process-groups/root/process-groups/import \
            -F "file=@flows/order-ingestion-test.xml"
